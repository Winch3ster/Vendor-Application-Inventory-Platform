@model List<string>
@{
    Layout = "_AdminControlPanel";
    ViewData["title"] = "Add Entries";
}

<div class="container-fluid">
  
      <div class="card mt-5">
        <div class="card-header">
          Add Countries
          <div class="progress mt-3" style="display: none;">
            <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          </div>
        <form id="countryForm" class="d-flex flex-column">
          @Html.AntiForgeryToken()
          <div class="card-body">
            <div id="country-container">
              @if (Model.Any())
              {
                @for (var i = 0; i < Model.Count(); i++)
                {
                  @if (i == 0)
                  {
                    <div class="p-1">
                      <input type="text" class="form-control text-uppercase" placeholder="Country" value="@Model.ElementAt(i)" pattern="[A-Za-z ]+" title="Alphabet and spaces only" required>
                    </div>
                  }
                  else
                  {
                    <div class="input-group p-1">
                      <input type="text" class="form-control text-uppercase" placeholder="Country" value="@Model.ElementAt(i)" pattern="[A-Za-z ]+" title="Numbers are not allowed" required>
                      <div class="input-group-append">
                        <span class="input-group-text btn btn-danger bi bi-dash" onclick="deleteCountry(event)"></span>
                      </div>
                    </div>
                  }
                }
              }
              else
              {
                <div class="p-1">
                  <input type="text" class="form-control text-uppercase" placeholder="Country" pattern="[A-Za-z ]+" title="Alphabet and spaces only" required>
                </div>
              }
              
            </div>

            <div class="d-flex justify-content-center mt-2">
              <div id="addCountryBtn" class="btn btn-primary bi bi-plus" style="width:50px" onclick="addCountry()"></div>
            </div>

          </div>
          <div class="card-footer d-flex justify-content-end">
            <div class="btn btn-info me-2" onclick="countryCancel()">Cancel</div>
            <button id="CountrySubmitBtn" class="btn btn-info">Submit</button>
          </div>
        </form>
    
    
  </div>
  <div id="tabs" class="row d-none mt-5">
    <ul class="nav nav-tabs">
      <div class="tab-pane fade show active"></div>
    </ul>
    <div id="tab-content" class="p-0"></div> 
  </div>
  <div class="row mt-3">
    <div class="col d-flex justify-content-end">
      <button id="submitBtn" class="btn btn-primary d-none">
        <div class="spinner-border spinner-border-sm text-info d-none" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <span>Submit</span>
      </button>
    </div>
    
  </div>
  
</div>

@section Scripts
{
  <script>
  
  $('#countryForm').on('submit', function (e){
    e.preventDefault();
    let countries = [];
    let countryInputs = $("[placeholder='Country']");
    let csrfToken = $('input[name="__RequestVerificationToken"]').val();

    
     countryInputs.each(function () {
       $(this).prop('disabled',true);
       countries.push($(this).val());
     });
     
      $('.progress').show();
      $('.progress-bar').css('width', '0%');
     
     const formData = { 'countryNames': countries };
        $("#addCountryBtn").attr('onclick','alert("Press Cancel First")');
        $(".bi-dash").attr('onclick', 'alert("Press Cancel First")');
        $("#tabs").removeClass('d-none');
        $('.nav-tabs').empty();
        $('#tab-content').empty();
        $('#submitBtn').removeClass('d-none');
        $('#CountrySubmitBtn').prop('disabled',true)
        
        $.post({
          url:"@Url.Action("CreateCountry")",
          data:formData,
          dataType: 'json',
          headers: {
                  "RequestVerificationToken": csrfToken
              },
          xhr: function () {
                              let xhr = new window.XMLHttpRequest();
                              xhr.upload.addEventListener("progress", function (evt) {
                                  if (evt.lengthComputable) {
                                      let percentComplete = (evt.loaded / evt.total) * 100;
                                      $('.progress-bar').css('width', percentComplete + "%");
                                  }
                              }, false);
                              return xhr;
                          },
          success:function (data){
            
            $('.progress').hide();
            
            if (data.success){
              countriesToTabs(data.countryNames);
            }
            else if (data.message){
              alert(data.message);
            }
            else{
              alert('Something went wrong')
            }
            
          },
          error:function (){
            $('.progress').hide();
            alert('Something went wrong')
          }
        })
  })
  
  let addCountry = () => {
    let countryField = `<div class="input-group p-1">
                            <input type="text" class="form-control text-uppercase" placeholder="Country" pattern="[A-Za-z ]+" title="Numbers are not allowed" required>
                            <div class="input-group-append">
                                 <span class="input-group-text btn btn-danger bi bi-dash" onclick="deleteCountry(event)"></span>
                            </div>
                        </div>`
    $('#country-container').append(countryField);
  }
  
  let countryCancel = () => {
    let countries = $("[placeholder='Country']");
    countries.each(function (){
      $(this).prop('disabled',false);
    })
    $("#addCountryBtn").attr('onclick','addCountry()');
    $(".bi-dash").attr('onclick', 'deleteCountry(event)');
    $("#tabs").addClass('d-none');
    $('#submitBtn').addClass('d-none');
    $('#CountrySubmitBtn').prop('disabled',false)
  }
  
  let deleteCountry = (e) => {
    $(e.target).parent().parent().remove();
  }
  
  let countriesToTabs = (countryNames) => {
    $.each(countryNames, function (index, value){
        if (value.trim() !== '') {

                    $('.nav-tabs').append(`
                        <li class="nav-item">
                            <a id="${value}-tab" class="nav-link" aria-current="page" onclick="tabsActive(event)" href="#${value}">${value}</a>
                        </li>
                    `);
        
                    let cityContainer = `
                        <div id="${value.replace(/\s/g, '-')}" class="cityContainer border border-top-0 py-4 px-3"></div>
                    `;
                    $('#tab-content').append(cityContainer);
                    
                   accordionForCities(value);
                }
    })
    tabsActive();
  }
  
  let accordionForCities = (element) => {

    //Check whether its the first default accordion or user triggered add accordion button
    let country = element?.target?$(element.target).closest('.cityContainer').attr('id'):element.replace(/\s/g, '-');
    //Get not used city number for ID to avoid duplicate ID before appending accordion
    let cityNumTaken=[];
    $('#'+country+' .accordion-collapse').each(function (){
      //Always get the last element of split that contains the city number
      let split = this.id.split('-')
      let cityTaken = split[split.length-1]
      cityNumTaken.push(parseInt(cityTaken.match(/\d+/g)))
      
    })
    
    //Find the ideal city number for accordion ID
    let cityNumber =1;
    while(cityNumTaken.includes(cityNumber)){
      cityNumber++;
    }
    let addCitiesBtn = `<div class="d-flex justify-content-center mt-2">
                            <button class="btn btn-primary bi bi-plus w-25" onclick="accordionForCities(event)"></button>
                        </div>`;
    let accordion = `<div class="accordion">
                             <div class="accordion-item">
                                 <h2 class="accordion-header">
                                   <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${country}-city${cityNumber}" aria-expanded="false" aria-controls="${country}-city${cityNumber}">
                                     City #${cityNumber}
                                   </button>
                                 </h2>
                                 <div id="${country}-city${cityNumber}" class="accordion-collapse collapse" aria-labelledby="${country}-city${cityNumber}">
                                   <div class="accordion-body">
                                     <form>
                                      @Html.AntiForgeryToken()
                                                     <div>
                                                       <input type="checkbox" class="address">
                                                       <label>Has Address</label>
                                                       <input class="contact ms-2" type="checkbox">
                                                       <label>Has Contact</label>
                                                     </div>
                                                     <div class="p-2 mt-2">
                                                       <input type="hidden" class="form-control" name="country" value="${country}">
                                                       <h5 class="mt-2">City</h5>
                                                       <input type="text" class="form-control" name="cityName" placeholder="City" required>
                                                       <div class="addressField mt-2 d-none">
                                                         <h5>Address</h5>
                                                         <input type="text" class="form-control mt-1" name="address1" placeholder="Address 1">
                                                         <input type="text" class="form-control mt-1" name="address2" placeholder="Address 2">
                                                         <input type="text" class="form-control mt-1" name="postcode" placeholder="Postcode">
                                                       </div>
                                                       <div class="contactField mt-2 d-none">
                                                         <h5>Contact</h5>
                                                         <input type="number" class="form-control mt-1" placeholder="Contact Number">
                                                       </div>
                                                     </div>
                                                   </form>
                                   </div>
                                 </div>
                               </div>
                           </form>`;
    //If the accordion is triggered by the user, remove the plus button and append it later after the appended the accordion
    //Also add delete city button for second city and beyond
    if (element.target){
      $(element.target).parent().remove()
      accordion = $(accordion).find('.accordion-body').append(`<div class="d-flex justify-content-end">
                                                                                           <button class="btn btn-danger" onclick="deleteCity(event)">Delete City</button>
                                                                                       </div>`).end();
    }
    $('.cityContainer#'+country).append(accordion).append(addCitiesBtn);
    
  }
  
  let tabsActive = (e) => {
    
    let tabs = $('.nav-link');
    
    $('.cityContainer').addClass('d-none')
    if ($('.nav-link.active').length>0){
      tabs.removeClass('active')
      $(e.target).addClass('active');
    }
    else{
      tabs.first().addClass('active');
    }
    
    tabs.each(function (){
                      let id = $(this).attr('id').split('-')[0].replace(/\s/g, '-')
                      if ($(this).hasClass('active')){
                        $('#'+id).removeClass('d-none')
                      }
                    })
    
      
    
    
  }
  
  let deleteCity = (e) => {
    let removeAccordionID = $(e.target).closest('.accordion-collapse').attr('id')
    let removeAccordionCityNumber = parseInt(removeAccordionID.match(/\d+/g))
    let country = $(e.target).closest('.cityContainer').attr('id')
    
    //Remove the selected accordion
    let accordion = $(e.target).closest('div.accordion')
    accordion.remove();
    
    //Rename the accordions
    $('#'+country+' .accordion .accordion-collapse').each(function (){
          let currentAccordionCityNumber = parseInt(this.id.match(/\d+/g));
          if (currentAccordionCityNumber > removeAccordionCityNumber){
            let button = $(this).siblings('.accordion-header').children('button');
            accordion = $('#'+this.id);
            let arrangedID = currentAccordionCityNumber-1;
            button.attr('aria-controls', country+'-'+'city'+arrangedID)
            button.attr('data-bs-target', '#' + country+'-' + 'city' + arrangedID)
            button.text('City #' + arrangedID)
            accordion.attr('id', country+'-'+'city'+arrangedID)
            accordion.attr('aria-labelledby', country+'-'+'city'+arrangedID)
          }
     })
  }
  
  $('#tab-content').on('change','input[type="checkbox"]', function(e){
    
        let className = $(e.target).attr('class').split(' ')[0];
        let target = $(e.target).parent().siblings().children('.'+className+'Field');
        
        if ($(e.target).is(':checked')){
          target.removeClass('d-none');
        }
        else{
          target.addClass('d-none')
          target.find('input').val('');
        }
  })
  
  //Check if user pressed the final submit button
  $('#submitBtn').click(function (){
    
    //check is all the required field are filled
    let validate = true;
    
    
    $('#tab-content').children().each(function (){
      let id = this.id;
      $(`#${id} .accordion-body > form`).each(function (){
            if (!validate){
              return false;
            }
            //if address or contact field is enabled, make those field a required field
            if ($(this).find('.address').prop('checked')){
              
              $('.addressField > input').prop('required', true)  
              
            }
            else{
              $('.addressField > input').prop('required', false) 
            }
            
            if ($(this).find('.contact').prop('checked')){
              $('.contactField > input').prop('required', true) 
            }
            else{
              $('.contactField > input').prop('required', false) 
            }
            
            
            if (!this.checkValidity()){
              validate=false;
              //Show the tabs and accordion that causes the validation
              $(`#${id}-tab`).click();
              let accordionCityFieldName = $(this).parent().parent().attr('aria-labelledby');
                      let accordionBtn = $(`[aria-controls=${accordionCityFieldName}]`);
                      if (accordionBtn.hasClass('collapsed')){
                        accordionBtn.click();
                      }
                      this.reportValidity();
              return false;
            }
            
          })
    })
    if (validate){
      //Disable the submit button and show spinner when form is valid and ready to submit
         let submitBtn = $('#submitBtn');
        submitBtn.prop('disabled', true);
        submitBtn.children('span').addClass('d-none');
        $('.spinner-border').removeClass('d-none');
        
        $('.accordion-body > form').each(function (){
          
          //Get the data for each of the form
          const data = {
            HasAddress: $(this).find(".address").prop("checked"),
                 
            HasContact: $(this).find(".contact").prop("checked"),
            
            CityName: $(this).find(".form-control[placeholder='City']").val(),
               
            Address1: $(this).find(".form-control[placeholder='Address 1']").val(),
               
            Address2: $(this).find(".form-control[placeholder='Address 2']").val(),
               
            Postcode: $(this).find(".form-control[placeholder='Postcode']").val(),
                    
            ContactNumber: $(this).find(".form-control[placeholder='Contact Number']").val(),
              
            Country: $(this).find("input[name='country']").val()
            
            };
          
          //replaces empty string with null
          for (const key in data) {
              if (data[key] === "") {
                  data[key] = null;
              }
          }
          
          finalSubmit(data);
          
        })
       }
  })
  
  function finalSubmit(data){
    
          $.post({
              url:'@Url.Action("CreateCities")',
              data: JSON.stringify(data),
              dataType:"json",
              contentType: 'application/json',
              success:function (data){
                if (data.errors){
                  alert(`${data.errors}\n\nCountry: ${data.country}\nCity: ${data.city}`)
                }
              },
              error:function (){
                alert('Failed to submit, please try again')
              }
          })
  }
          
    let placeholder = document.getElementById("add-entries");
    
        let indicatorList = document.getElementsByClassName("indicator");
    
        for (let i = 0; i < indicatorList.length; i++){
            indicatorList[i].classList.add("indicator-off");
        }
    
        placeholder.classList.remove("indicator-off");
    </script>
}
